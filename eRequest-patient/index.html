<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AU eRequesting – Consumer App</title>
  <meta name="description" content="Scan a QR code for an AU eRequesting Task group and view patient details and requested services." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://unpkg.com/@fontsource/inter@5.0.18/variable.css" rel="stylesheet">

<style>
/* Patient friendly mint theme with soft background */
:root {
--bg-gradient:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 50%,#99f6e4 100%);
--panel:#fefefe; --muted:#335c52; --text:#0f172a;
--brand:#10b981; --danger:#ef4444; --ok:#16a34a; --border:#86efac; --chip:#d1fae5;
}
html,body{height:100%}
body{
margin:0;font-family:"InterVariable",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
background:var(--bg-gradient);color:var(--text);
}
.container{max-width:1000px;margin:0 auto;padding:24px}
.app-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 14px rgba(0,0,0,0.15);overflow:hidden}
header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);background:var(--brand);color:white}
header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
header .badge{font-size:12px;color:#d1fae5}
.content{display:grid;grid-template-columns:1fr;gap:18px;padding:20px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
.row{display:grid;gap:6px} /* smaller gap under headers */
h2, h3 {margin-bottom:4px; margin-top:0;}
.btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:white;border:1px solid var(--brand);padding:10px 12px;border-radius:8px;cursor:pointer;user-select:none;text-decoration:none;font-weight:600;transition:background .2s}
.btn:hover{background:#059669}
.btn.ghost{background:transparent;color:var(--brand)}
.btn.small{padding:6px 10px;font-size:12px}
.hint{font-size:12px;color:var(--muted)}
.input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:white;color:var(--text)}
.hr{height:1px;background:var(--border);margin:12px 0;border:0}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:4px 10px;border-radius:999px;font-size:11px}
/* Larger clearer chips for patient instructions */
#instructions .chip {
font-size:14px;
font-weight:600;
padding:6px 14px;
background:#ccfbf1;
border-color:#5eead4;
}
.list{display:flex;flex-direction:column;gap:6px}
.sr-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 8px;background:#ecfdf5;border-radius:8px;font-size:13px;border:1px solid var(--border)}
.sr-name{font-weight:600;}
.sr-status{display:flex;gap:6px;align-items:center;}
.sr-status .chip{font-size:12px;padding:2px 8px;}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:var(--muted)}
.grid-2{display:grid;grid-template-columns:80px 1fr;gap:10px;align-items:center}
.avatar{width:72px;height:72px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#bbf7d0;display:block}
.status{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#ecfdf5;color:var(--muted)}
.qr-area{display:none}.show{display:block!important}
.error{color:var(--danger)}.success{color:var(--ok)}.muted{color:var(--muted)}
#detailsPanel{display:none}
#loadPanel{grid-column:1/-1}
.placeholder{width:72px;height:72px;border-radius:12px;border:1px solid var(--border);background:#bbf7d0;display:flex;align-items:center;justify-content:center;color:var(--muted)}
/* Ensure searchAgainBtn is always visible when displayed */
#searchAgainBtn {
display:none;
background:var(--chip);
color:var(--text);
border:1px solid var(--border);
}
#searchAgainBtn.show {
display:inline-flex !important;
}
/* Clinical notes as plain larger text */
#notes {display:flex;flex-direction:column;gap:6px;font-size:16px;line-height:1.4;color:var(--text)}
#notes div {background:none;border:none;padding:0;margin:0}
</style>

  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div class="container">
    <div class="app-card">
      <header>
        <div>
          <h1>AU eRequesting — Consumer App</h1>
          <div class="badge">Scan a QR code or paste a Task URL to view the requisition</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="status" id="status">Idle</div>
          <button id="searchAgainBtn" class="btn ghost small">Search again</button>
        </div>
      </header>

      <div class="content">
        <!-- LOAD (full width). Desktop: URL. Mobile: QR by default -->
        <section id="loadPanel" class="panel">
          <h2>Load Request</h2>

          <!-- Desktop URL entry -->
          <div id="desktopOptions" class="row">
            <label for="taskUrl" class="hint">Task URL <span class="muted">(QR Reader available on mobile)</span></label>
            <input id="taskUrl" class="input" placeholder="Paste a Task URL… e.g. https://server.fire.ly/Task/1234-..." />
            <button class="btn primary" id="loadBtn">Load</button>
          </div>

          <!-- Mobile QR-first -->
          <div id="mobileOptions" class="row" style="display:none;">
            <div class="hint">Point your camera at the requisition QR code.</div>
            <div id="qrArea" class="qr-area show">
              <div id="qrReader" style="width:100%; max-width: 360px;"></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <label class="btn ghost" for="qrImage">Scan from image</label>
              <input id="qrImage" type="file" accept="image/*" style="display:none" />
              <button class="btn" id="switchDesktopBtn">Switch to desktop mode</button>
            </div>
          </div>
        </section>

        <!-- DETAILS (shown after load) -->
        <section id="detailsPanel" class="panel" style="grid-column:1/-1;">
          <h2>Details</h2>

          <div class="row">
            <div class="chips">
              <span class="chip"><strong>Requisition:</strong>&nbsp;<span id="reqId">—</span></span>
              <span class="chip"><strong>Created:</strong>&nbsp;<span id="reqCreated">—</span></span>
            </div>
          </div>

          <div class="row">
            <h3>Patient</h3>
            <div id="patientCard" class="grid-2">
              <div class="avatarWrap" id="avatarWrap">
                <img id="patientPhoto" class="avatar" alt="Patient photo" />
                <!-- SVG placeholder is injected here if no photo -->
              </div>
              <div>
                <div id="patientName" style="font-weight:700;">—</div>
                <div id="patientAge" class="muted">—</div>
              </div>
            </div>
          </div>

          <hr class="hr" />

          <!-- Instructions ABOVE notes -->
          <div class="row">
            <h3>Patient instructions</h3>
            <div id="instructions" class="chips"></div>
          </div>

          <div class="row">
            <h3>Clinical notes</h3>
            <div id="notes" class="chips"></div>
          </div>

          <hr class="hr" />

          <div class="row">
            <h3>Requested services</h3>
            <div id="srList" class="list"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const setStatus = (t,k) => { statusEl.textContent=t; statusEl.className="status"; if(k==="error")statusEl.classList.add("error"); if(k==="ok")statusEl.classList.add("success"); };

    const FHIR_HEADERS = { "Accept": "application/fhir+json" };

    const isMobileUA = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.matchMedia("(max-width: 820px)").matches;

    function isTaskUrl(u){ try { return /\/Task\/[^/?#]+/.test(new URL(u).pathname); } catch { return false; } }
    function parseServerFromTaskUrl(u){
      const url = new URL(u);
      const parts = url.pathname.split("/").filter(Boolean);
      const idx = parts.findIndex(p => p.toLowerCase() === "task");
      return idx > 0 ? `${url.origin}/${parts.slice(0, idx).join("/")}` : url.origin;
    }
    function extractTaskId(u){ const m = new URL(u).pathname.match(/\/Task\/([^\/]+)/i); return m ? m[1] : null; }

    function humanName(hn){
      if (!hn) return "—";
      const list = Array.isArray(hn) ? hn : [hn];
      const best = list.find(n => n.use === "official") || list[0];
      return [ ...(best?.prefix||[]), ...(best?.given||[]), best?.family||"" ].join(" ").replace(/\s+/g," ").trim() || "—";
    }
    function calcAge(d){ if(!d) return "—"; const t=new Date(), b=new Date(d); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate())) a--; return `${a} years`; }
    function codeableDisplay(cc){ if(!cc) return "—"; const c=(cc.coding||[])[0]; return c?.display || cc?.text || "—"; }
    function uniqStrings(a){ return [...new Set(a.filter(x => typeof x==="string" && x.trim()).map(x => x.trim()))]; }

    // Normalizes absolute/relative "ResourceType/id"
    function asResource(ref){
      if (!ref || !ref.reference) return null;
      const r = ref.reference;
      try {
        const url = new URL(r, location.origin);
        const m = url.pathname.match(/\/([A-Za-z]+)\/([^\/]+)/);
        return m ? { type:m[1], id:m[2] } : null;
      } catch { return null; }
    }

    async function fhirGET(url, params={}){
      const full = new URL(url);
      Object.entries(params).forEach(([k,v]) => { if(v!==undefined && v!==null && v!=="") full.searchParams.set(k,v); });
      const res = await fetch(full.toString(), { headers: FHIR_HEADERS });
      if(!res.ok){
        const text = await res.text();
        throw new Error(`GET ${full}: ${res.status} — ${text}`);
      }
      return res.json();
    }
    async function readResource(base, type, id){ return fhirGET(`${base}/${type}/${encodeURIComponent(id)}`); }
    async function searchResources(base, type, query){ return fhirGET(`${base}/${type}`, query); }
    function gather(bundle){ return (bundle?.entry||[]).map(e => e.resource).filter(Boolean); }

    // ---------- Desktop vs Mobile UI ----------
    const loadPanel = $("loadPanel");
    const desktopOptions = $("desktopOptions");
    const mobileOptions = $("mobileOptions");
    const taskUrlInput = $("taskUrl");
    const loadBtn = $("loadBtn");
    const qrArea = $("qrArea");
    const qrReaderDivId = "qrReader";
    const switchDesktopBtn = $("switchDesktopBtn");
    const searchAgainBtn = $("searchAgainBtn");

    let qrScanner = null;
    let qrActive = false;

    function showDesktop(){
      desktopOptions.style.display = "grid";
      mobileOptions.style.display = "none";
      stopQr();
    }
    function showMobile(){
      desktopOptions.style.display = "none";
      mobileOptions.style.display = "grid";
      startQr();
    }

    async function startQr(){
      qrArea.classList.add("show");
      if(qrActive) return;
      qrActive = true;
      if(qrScanner){ try{ await qrScanner.clear(); }catch{} }
      qrScanner = new Html5Qrcode(qrReaderDivId);
      const config = { fps: 10, qrbox: 240, aspectRatio: 1.0 };
      const onSuccess = (decodedText) => {
        if(decodedText){
          taskUrlInput.value = decodedText.trim();
          stopQr();
          loadBtn.click();
        }
      };
      const onError = (_e) => {};
      try {
        await qrScanner.start({ facingMode: "environment" }, config, onSuccess, onError);
        setStatus("QR reader active");
      } catch (e) {
        setStatus("QR reader unavailable — paste a URL instead", "error");
      }
    }
    async function stopQr(){
      if(qrScanner){
        try{ await qrScanner.stop(); }catch{}
        try{ await qrScanner.clear(); }catch{}
      }
      qrArea.classList.remove("show");
      qrActive = false;
      setStatus("QR reader closed");
    }

    // Init preferred mode
    window.addEventListener("DOMContentLoaded", () => {
      if(isMobileUA) showMobile(); else showDesktop();
      // support ?task= prefill
      const params = new URLSearchParams(location.search);
      const t = params.get("task");
      if(t){ taskUrlInput.value = t; if(!isMobileUA) taskUrlInput.focus(); }
    });

    // Switch to desktop mode on mobile
    switchDesktopBtn.addEventListener("click", showDesktop);

    // Scan-from-image
    $("qrImage").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try {
        await Html5Qrcode.getCameras().catch(()=>{});
        const text = await Html5Qrcode.scanFile(file, true);
        taskUrlInput.value = (text || "").trim();
        setStatus("QR decoded from image", "ok");
      } catch (err) {
        setStatus("Failed to decode QR image", "error");
        console.error(err);
      }
    });

    // Header: Search again
    searchAgainBtn.addEventListener("click", () => location.reload());

    // ---------- Load flow ----------
    loadBtn.addEventListener("click", async () => {
      const url = taskUrlInput.value.trim();
      if(!url){ setStatus("Enter or scan a Task URL first", "error"); return; }
      if(!isTaskUrl(url)){ setStatus("That doesn’t look like a Task URL", "error"); return; }
      setStatus("Fetching…");
      try {
        await loadFromTaskUrl(url);
      } catch (err) {
        console.error(err);
        setStatus(err.message || "Load failed", "error");
      }
    });

    async function loadFromTaskUrl(taskUrl){
      const base = parseServerFromTaskUrl(taskUrl);
      const id = extractTaskId(taskUrl);
      if(!id) throw new Error("Unable to extract Task id from URL.");

      // Root Task and children
      const root = await readResource(base, "Task", id);
      const children = gather(await searchResources(base, "Task", { "part-of": `Task/${id}`, _count: "100" }));
      const allTasks = [root, ...children];

      // Map SR -> Task via focus/basedOn (normalize absolute/relative)
      const srIds = new Set();
      const srToTask = new Map();
      for(const t of allTasks){
        if(t.focus){
          const f = asResource(t.focus);
          if(f?.type==="ServiceRequest"){ srIds.add(f.id); if(!srToTask.has(f.id)) srToTask.set(f.id, t); }
        }
        if(Array.isArray(t.basedOn)){
          for(const b of t.basedOn){
            const r = asResource(b);
            if(r?.type==="ServiceRequest"){ srIds.add(r.id); if(!srToTask.has(r.id)) srToTask.set(r.id, t); }
          }
        }
      }

      // Fetch ServiceRequests (filter to SR only to avoid OperationOutcome etc.)
      let srs = [];
      if(srIds.size){
        srs = gather(await searchResources(base, "ServiceRequest", { _id: Array.from(srIds).join(","), _count: "100" }))
                .filter(r => r.resourceType === "ServiceRequest");
      } else {
        srs = gather(await searchResources(base, "ServiceRequest", { basedOn: `Task/${id}`, _count: "100" }))
                .filter(r => r.resourceType === "ServiceRequest");
      }

      // Resolve Patient from first SR
      let patient = null;
      const firstSR = srs.find(x => x?.subject);
      if(firstSR?.subject){
        const subj = asResource(firstSR.subject);
        if(subj?.type==="Patient"){
          try { patient = await readResource(base, "Patient", subj.id); } catch {}
        }
      }

      // Distinct instructions & notes (reasons intentionally excluded)
      const instructions = [];
      const notes = [];
      for(const sr of srs){
        if(sr.patientInstruction) instructions.push(sr.patientInstruction);
        if(Array.isArray(sr.note)) sr.note.forEach(n => { if(n?.text) notes.push(n.text); });
      }

      render({
        root,
        patient,
        srs,
        srToTask,
        distinctInstructions: uniqStrings(instructions),
        distinctNotes: uniqStrings(notes)
      });

      // Reveal details, hide loader, show Search again
      $("detailsPanel").style.display = "block";
      loadPanel.style.display = "none";
      $("searchAgainBtn").style.display = "inline-flex";
      setStatus("Loaded", "ok");
    }

    // ---------- Render ----------
    function render({ root, patient, srs, srToTask, distinctInstructions, distinctNotes }){
      // Requisition header
      $("reqId").textContent = root?.id || "—";
      $("reqCreated").textContent = root?.authoredOn || root?.created || root?.meta?.lastUpdated || "—";

      // Patient identity
      $("patientName").textContent = patient ? humanName(patient.name) : "—";
      $("patientAge").textContent = patient?.birthDate ? `${calcAge(patient.birthDate)} (DOB ${patient.birthDate})` : "—";

      // Patient photo or placeholder SVG
      const photo = (patient?.photo || [])[0];
      const photoEl = $("patientPhoto");
      const avatarWrap = $("avatarWrap");
      // Clear previous SVG placeholder if any
      Array.from(avatarWrap.querySelectorAll("svg")).forEach(s => s.remove());
      if(photo?.url){
        photoEl.src = photo.url;
        photoEl.style.display = "block";
      } else if(photo?.data && photo?.contentType){
        photoEl.src = `data:${photo.contentType};base64,${photo.data}`;
        photoEl.style.display = "block";
      } else {
        photoEl.removeAttribute("src");
        photoEl.style.display = "none";
        // Inject a simple avatar placeholder SVG (person silhouette + cross)
        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox","0 0 80 80");
        svg.setAttribute("width","72");
        svg.setAttribute("height","72");
        svg.innerHTML = `
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="#223055"/>
              <stop offset="100%" stop-color="#0e1a3b"/>
            </linearGradient>
          </defs>
          <rect x="1" y="1" width="78" height="78" rx="12" fill="url(#g)" stroke="#223055"/>
          <circle cx="40" cy="28" r="12" fill="#2a3a6a"/>
          <rect x="18" y="44" width="44" height="22" rx="11" fill="#2a3a6a"/>
          <g transform="translate(52,52)">
            <rect x="-8" y="-2" width="16" height="4" rx="2" fill="#5cc2ff"/>
            <rect x="-2" y="-8" width="4" height="16" rx="2" fill="#5cc2ff"/>
          </g>
        `;
        avatarWrap.appendChild(svg);
      }

      // Instructions first
      const instEl = $("instructions"); instEl.innerHTML = "";
      if(!distinctInstructions.length){
        const s = document.createElement("span"); s.className="muted"; s.textContent="No patient instructions present."; instEl.appendChild(s);
      } else {
        distinctInstructions.forEach(i => { const d=document.createElement("div"); d.className="chip"; d.textContent=i; instEl.appendChild(d); });
      }

      // Clinical notes (reasons excluded)
      const notesEl = $("notes"); notesEl.innerHTML = "";
      if(!distinctNotes.length){
        const s = document.createElement("span"); s.className="muted"; s.textContent="No clinical notes present."; notesEl.appendChild(s);
      } else {
        distinctNotes.forEach(n => { const d=document.createElement("div"); d.className="chip"; d.textContent=n; notesEl.appendChild(d); });
      }

      // ServiceRequests: tight list — test name + Task status & businessStatus only
      const listEl = $("srList"); listEl.innerHTML = "";
      if(!srs.length){
        const div = document.createElement("div"); div.className="muted"; div.textContent="No ServiceRequests were found for this requisition."; listEl.appendChild(div);
      } else {
        for(const sr of srs){
          const task = srToTask.get(sr.id);
          const tStatus = task?.status || "unknown";
          const tBiz = codeableDisplay(task?.businessStatus);
          const testName = codeableDisplay(sr.code);

          const item = document.createElement("div");
          item.className = "sr-item";
          item.innerHTML = `
            <div style="font-weight:600;min-width:180px;flex:1 1 auto;">${escapeHtml(testName)}</div>
            <div class="chips" style="gap:6px;">
              <span class="chip" title="Task status">${escapeHtml(tStatus)}</span>
              ${tBiz && tBiz !== "—" ? `<span class="chip" title="Business status">${escapeHtml(tBiz)}</span>` : ""}
            </div>
          `;
          listEl.appendChild(item);
        }
      }
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
